#!/bin/python3

import subprocess
import time


def omen_fan_speed(temp: float) -> int:
    """
    Fan curve with 5°C segments.
    Output range: 0–65%

    30–35 : 20 → 25
    35–40 : 25 → 30
    40–45 : 30 → 35
    45–50 : 35 → 40
    50–55 : 40 → 45
    55–60 : 45 → 52
    60–65 : 52 → 60
    65–70 : 60 → 65
    """

    if temp < 30:
        return 0
    if temp >= 70:
        return 65

    # (low, high, fan_start, fan_end)
    segments = [
        (30, 35, 20, 25),
        (35, 40, 25, 30),
        (40, 45, 30, 35),
        (45, 50, 35, 40),
        (50, 55, 40, 45),
        (55, 60, 45, 52),
        (60, 65, 52, 60),
        (65, 70, 60, 65),
    ]

    for t0, t1, f0, f1 in segments:
        if t0 <= temp < t1:
            return round(f0 + (temp - t0) * (f1 - f0) / (t1 - t0))


def round_to_prev_five(value):
    return ((value // 5) * 5) - 5


# AC status
with open('/sys/class/power_supply/ACAD/online', 'r') as f:
    status = int(f.read(1))


def read_temp():
    with open('/sys/devices/virtual/thermal/thermal_zone0/temp', 'r') as f:
        return int(f.read().strip())


# Read temperature correctly (raw in millidegrees)
t1 = read_temp()
time.sleep(0.5)
t2 = read_temp()

raw_temp = (t1 + t2) / 2
actual_temp = raw_temp // 1000  # correct conversion


# Compute fan speed
fan_value = omen_fan_speed(actual_temp)
# fan_value = round_to_prev_five(fan_value)

print(f"AC:{status} Temp:{actual_temp}°C Fan:{fan_value}")

# Call external fan controller
if fan_value == 0:
    subprocess.run(['/usr/local/bin/fan_max', '0'])
else:
    subprocess.run(['/usr/local/bin/fan_speed', str(fan_value)])
